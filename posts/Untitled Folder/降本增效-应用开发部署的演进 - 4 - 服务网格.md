# 服务网格 - service mesh

## sidecar pattern

[Pattern: Service Mesh](https://philcalcado.com/2017/08/03/pattern_service_mesh.html)

<img src="http://devops-1255386119.cos.ap-beijing.myqcloud.com/2023-01-08-142535.png" alt="img"  />

<img src="http://devops-1255386119.cos.ap-beijing.myqcloud.com/2023-01-08-142721.png" alt="service-mesh-schematic-diagram" style="zoom:80%;" />

sidecar模式存在的问题：

- 新业务接入为注入sidecar需更新应用、存量业务sidecar更新
- sidecar性能开销
- 4层的代理没必要走sidecar，有没有可能4层和7层的流量按照不同的方式处理？

## ambient mesh

[Introducing Ambient Mesh](https://istio.io/latest/blog/2022/introducing-ambient-mesh/)

### ztunnel - 4层代理

<img src="http://devops-1255386119.cos.ap-beijing.myqcloud.com/2023-01-08-164155.png" alt="Ambient mesh uses a shared, per-node ztunnel to provide a zero-trust secure overlay" style="zoom:67%;" />

### ztunnel + Waypoint Proxy - 7层代理

<img src="http://devops-1255386119.cos.ap-beijing.myqcloud.com/2023-01-08-164227.png" alt="img" style="zoom:67%;" />



> <img src="http://devops-1255386119.cos.ap-beijing.myqcloud.com/2023-01-08-163439.png" alt="Each namespace/identity has its own L7 proxies; no multi-tenant proxies" style="zoom:67%;" />
> Each namespace/identity has its own L7 proxies; no multi-tenant proxies
>
> Supporting L7 protocols such as HTTP 1/2/3, gRPC, parsing headers, implementing retries, customizations with Wasm and/or Lua in the data plane is significantly more complex than supporting L4. There is a lot more code to implement these behaviors (including user-custom code for things like Lua and Wasm) and this complexity can lead to the potential for vulnerabilities. Because of this, CVEs have a higher chance of being discovered in these areas of L7 functionality.
>
> Trying to co-locate multiple identities and their distinct complex policies and customizations adds a lot of variability to a shared resource which leads to unfair cost attribution at best and total proxy compromise at worst.
>
> So in ambient mesh, we do not share L7 processing in a proxy across multiple identities. Each identity (service account in Kubernetes) has its own dedicated L7 proxy (waypoint proxy) which is very similar to the model we use with sidecars.
>
> 摘自[Ambient Mesh Security Deep Dive](https://istio.io/latest/blog/2022/ambient-security/)



<img src="http://devops-1255386119.cos.ap-beijing.myqcloud.com/2023-01-08-080628.png" alt="img" style="zoom:67%;" />

<img src="http://devops-1255386119.cos.ap-beijing.myqcloud.com/2023-01-08-080625.png" alt="img" style="zoom:67%;" />

<img src="http://devops-1255386119.cos.ap-beijing.myqcloud.com/2023-01-08-080651.png" alt="img" style="zoom: 50%;" />



数据面 + 控制面

## Envoy
### xDS - UDPA

[UDPA 最新进展深度介绍](https://mosn.io/blog/posts/udpa-follow-up/)

<img src="http://devops-1255386119.cos.ap-beijing.myqcloud.com/2023-01-08-144734.png" alt="img" style="zoom:80%;" />

## SMI-spec
