# 提高集群的利用率
## 容器编排 - container orchestration

有了容器的概念之后，大规模应用应用时，应该如何编排管理这些容器呢？总不能手工吧，我们需要一个容器的编排管理平台。

Docker Swarm、apache mesos、[kubernetes](https://kubernetes.io/)(下文简称K8S) 等当时涌现出一系列的容器编排工具，最终K8S凭借出色的技术和生态脱颖而出。

> ##### 技术
>
> 虽然K8S的诞生比较晚，但实际上K8S是基于Google [Borg/Omega](https://research.google/pubs/pub43438/)基础设施的开发而来的，后者已经在google内部发展了15年之久，K8S吸取了Borg/Omega的经验和教训，可以说是站在了巨人的肩膀上。
>
> - **声明式API**
> - **模块化、易于扩展的架构**
>
> ##### 生态
>
> google的背书、模块化可扩展的架构、促进了繁荣的社区和生态系统、更多的feature、良性循环

时至今日，K8S已经成为容器编的事实标准。

由于容器的本质是一个进程，所以K8S则是一个跨网络的进程调度系统，也经常被称为云原生操作系统"Linux of the cloud"。

至此已经有了3个层次的操作系统, 操作系统(linux)、容器编排对应的操作系统(k8s)、虚拟机编排对应的操作系统(openstack), 那是不是也可以认为coroutine(goroutine)是用户态操作系统呢？

<img src="http://devops-1255386119.cos.ap-beijing.myqcloud.com/2023-01-08-100447.jpg" alt="img" style="zoom:67%;" />

<img src="http://devops-1255386119.cos.ap-beijing.myqcloud.com/2023-01-07-052508.jpg" alt="5.jpg" style="zoom: 67%;" />

## K8S

### 架构

<img src="http://devops-1255386119.cos.ap-beijing.myqcloud.com/2023-01-09-033053.png" alt="image-20230109113053219" style="zoom:67%;" />

<img src="http://devops-1255386119.cos.ap-beijing.myqcloud.com/2023-01-04-131222.jpg" alt="img" style="zoom:67%;" />

### 工作负载 - workload

#### why pod

### 声明式模型

![自定义控制器的工作流程示意图](http://devops-1255386119.cos.ap-beijing.myqcloud.com/2023-01-08-063647.png)

### 容器运行时-CRI

**抽象拆分系统、定义接口、允许不同的实现，允许更多的组织和开发者加入进来，促进生态繁荣**

CRI的出现让docker在K8S成为一个可以随时被替换的插件。

其中K8S中的RuntimeClass就是为了支持配置不同的OCI实现。

<img src="http://devops-1255386119.cos.ap-beijing.myqcloud.com/2023-01-09-143659.png" alt="img" style="zoom:52%;" />

<img src="http://devops-1255386119.cos.ap-beijing.myqcloud.com/2023-01-09-141403.png" alt="container-ecosystem.drawio" style="zoom:84%;" />

图片摘自[The differences between Docker, containerd, CRI-O and runc](https://www.tutorialworks.com/difference-docker-containerd-runc-crio-oci/)

#### K8S抛弃Docker

抛弃的是docker deamon。

最初kubelet是通过dockershim与docker daemon进行通讯的。

<img src="http://devops-1255386119.cos.ap-beijing.myqcloud.com/2023-01-09-142348.png" alt="img" style="zoom:100%;" />

<img src="http://devops-1255386119.cos.ap-beijing.myqcloud.com/2023-01-09-142414.png" alt="containerd" style="zoom:100%;" />

<img src="http://devops-1255386119.cos.ap-beijing.myqcloud.com/2023-01-09-142952.png" alt="img" style="zoom:80%;" />

图片摘自[Kubernetes Containerd Integration Goes GA](https://kubernetes.io/blog/2018/05/24/kubernetes-containerd-integration-goes-ga/)

### 存储接口-CSI

### 网络接口-CNI

#### Cilium - eBPF
#### Calico 
#### Flannel

### Operator & CRD


### Ingress & Gateway API

### K8S发行版

#### TKE

<img src="http://devops-1255386119.cos.ap-beijing.myqcloud.com/2023-01-09-051747.png" alt="tkestackhighlevelarchitecture-2x" style="zoom:67%;" />

图片摘自[tke-installation-architecture](https://github.com/tkestack/tke/blob/master/docs/guide/zh-CN/installation/installation-architecture.md)

- Kubernetes on Kubernetes

#### Serverless K8S

<img src="http://devops-1255386119.cos.ap-beijing.myqcloud.com/2023-01-08-092308.png" alt="ECI架构" style="zoom:75%;" />

[Serverless Kubernetes](https://www.infoq.cn/article/xkjnoczvdharlkkjvdom) 主要是通过virtual kubelet与现有的虚拟机管理系统进行交互，能够充分利用虚拟机的碎片

---

**[查看原文](https://oops-oom.github.io/posts/%E9%99%8D%E6%9C%AC%E5%A2%9E%E6%95%88-%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E7%9A%84%E6%BC%94%E8%BF%9B/%E9%99%8D%E6%9C%AC%E5%A2%9E%E6%95%88-%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E9%83%A8%E7%BD%B2%E7%9A%84%E6%BC%94%E8%BF%9B%20-%200%20-%20%E5%AF%BC%E8%AF%AD.html)**
